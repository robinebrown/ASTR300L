from math import sqrt

sky_x_values = [419,420,421,422,423,424,425,426,427,428,429,430,431,432,433]
sky_y_values = [516,517,518,519,520,521,522,523,524,525,526,527,528,529,530]
sky_data = [
    [477.7,474.7,471.9,482.8,490.3,464.1,463.4,490.1,499.7,478.1,470.5,483.3,445.7,464.4,464.5],
    [452.1,485.1,456.6,464.2,452.3,458.1,478.6,446.3,460.6,490.1,487.7,455.5,482.1,471.2,463.1],
    [487.7,495.4,497.9,439.6,480.0,498.5,461.8,469.9,492.5,480.5,474.8,473.1,498.3,447.9,486.1],
    [444.9,475.7,444.8,457.4,483.6,485.1,457.3,456.6,485.9,478.3,450.8,481.0,460.2,454.6,444.7],
    [470.6,460.6,440.2,451.5,489.0,464.5,468.1,510.7,462.0,474.1,474.4,453.4,444.7,455.2,460.6],
    [469.9,466.3,464.3,451.6,459.1,461.3,480.5,457.7,450.0,460.4,469.2,470.6,463.4,444.0,465.7],
    [497.2,465.2,457.3,483.8,463.7,454.8,410.4,470.9,459.2,446.8,479.8,473.9,466.8,480.2,478.1],
    [465.5,508.0,435.5,463.6,486.9,501.0,490.9,496.8,452.7,506.3,446.8,483.7,489.9,484.3,455.8],
    [472.5,466.7,455.0,463.6,485.7,474.9,453.4,470.3,485.3,469.8,473.3,484.2,442.7,442.5,415.8],
    [449.3,458.2,456.5,464.4,475.1,436.2,471.5,468.6,414.8,468.4,446.5,445.4,453.9,471.7,461.2],
    [497.0,484.0,428.9,467.4,472.1,456.4,508.0,470.6,482.0,433.8,453.3,457.9,470.3,484.5,466.0],
    [459.3,442.5,454.9,458.8,482.4,468.6,448.4,471.0,453.3,471.0,447.8,465.0,466.3,464.2,474.7],
    [480.8,468.8,462.6,476.4,473.7,484.3,490.0,477.9,464.5,505.9,460.6,478.4,453.1,471.3,461.0],
    [436.7,466.9,494.3,474.9,460.4,479.9,486.9,442.4,479.0,454.9,460.8,465.0,441.2,445.3,428.4],
    [451.7,472.9,470.0,455.2,472.2,466.8,455.9,458.8,437.6,453.1,457.1,460.4,446.7,416.9,446.1],
]

star_x_values = [398,399,400,401,402,403,404,405,406,407,408,409,410,411,412]
star_y_values = [530,531,532,533,534,535,536,537,538,539,540,541,542,543,544]
star_data = [
    [496.6,484.0,470.8,450.4,477.0,472.6,436.7,482.1,476.2,475.6,458.6,452.5,465.7,474.6,437.7],
    [459.6,518.0,494.4,479.1,449.7,479.6,534.9,483.2,483.9,501.9,524.2,488.2,503.0,492.9,491.1],
    [489.8,453.5,468.4,490.6,517.8,567.2,520.0,592.2,579.5,564.3,514.5,486.4,451.3,468.3,506.2],
    [492.8,504.6,515.9,540.3,571.9,613.4,735.7,845.7,773.4,660.6,568.1,533.3,469.8,517.2,448.4],
    [451.5,449.8,478.3,530.3,598.6,823.6,1364.4,2015.3,1756.1,1029.7,682.3,550.1,499.1,493.5,510.3],
    [482.6,490.6,507.6,543.1,724.0,1378.4,3584.9,6681.0,5203.0,2074.8,868.4,631.7,480.5,488.7,471.8],
    [480.8,481.9,494.5,600.7,859.7,2124.1,6968.8,14778.4,11374.7,3617.6,1131.6,643.8,533.4,483.7,483.1],
    [459.4,496.8,520.1,579.5,862.6,2061.0,6982.9,14665.0,11672.4,3644.1,1120.2,605.2,501.5,453.4,440.1],
    [476.5,491.4,526.8,591.5,760.9,1481.6,3890.1,7282.7,5761.7,2217.6,852.8,566.7,479.3,466.6,484.8],
    [502.4,518.1,472.5,554.2,648.5,885.4,1627.9,2328.5,1936.9,1002.3,674.3,550.3,466.0,454.7,472.1],
    [490.8,489.6,548.8,528.2,572.1,722.6,916.9,972.0,834.6,693.2,566.7,518.0,513.3,512.0,456.8],
    [485.4,471.7,471.4,495.2,507.0,558.1,609.2,642.6,595.1,554.5,534.2,520.7,469.7,467.7,464.0],
    [490.9,471.9,480.2,503.1,488.5,558.4,545.8,526.8,532.5,491.6,485.7,470.7,493.6,479.0,451.8],
    [473.6,466.6,473.2,461.9,468.7,463.5,482.9,513.5,518.2,453.5,493.5,461.3,486.2,457.4,495.0],
    [464.0,458.4,422.0,461.1,489.1,478.8,433.6,515.6,494.7,527.7,483.6,493.2,490.7,468.3,480.5],
]
# Sample mean and variance for Sky (a)
sky_total = 0.0
sky_total_sq = 0.0
sky_N = 0
for row in sky_data:
    for p in row:
        sky_total += p
        sky_total_sq += p*p
        sky_N += 1
sky_mean = sky_total / sky_N
sky_variance  = (sky_total_sq - sky_N*sky_mean*sky_mean) / (sky_N - 1)

# Flux, centroids, second moments
y_N = len(star_y_values)
x_N = len(star_x_values)

total_flux = 0.0
sum_w = 0.0
sum_xw = 0.0
sum_yw = 0.0

# Flux and centroid weights
for a in range(y_N):
    y = star_y_values[a]
    row = star_data[a]
    for b in range(x_N):
        x = star_x_values[b]
        I = row[b]
        w = I - sky_mean
        total_flux += w
        sum_w += w
        sum_xw += x * w
        sum_yw += y * w

x_cen = sum_xw / sum_w
y_cen = sum_yw / sum_w

# second moments and cross term
sum_w_x2 = 0.0
sum_w_y2 = 0.0
sum_w_xy = 0.0

for a in range(y_N):
    y = star_y_values[a]
    dy = y - y_cen
    row = star_data[a]
    for b in range(x_N):
        x = star_x_values[b]
        dx = x - x_cen
        w = row[b] - sky_mean
        sum_w_x2 += w * dx * dx
        sum_w_y2 += w * dy * dy
        sum_w_xy += w * dx * dy

second_moment_x  = sum_w_x2 / sum_w
second_moment_y  = sum_w_y2 / sum_w
second_moment_xy = sum_w_xy / sum_w

sum_star_raw = 0.0
for row in star_data:
    for p in row:
        sum_star_raw += p

N_pixels = x_N * y_N
flux_variance = sum_star_raw + N_pixels * (1.0 + N_pixels/float(sky_N)) * sky_variance
flux_error = sqrt(flux_variance)

print(f"(a) Average sky background: {sky_mean}")
print(f"(b) Flux: {total_flux}")
print(f"(c) Error in flux: {flux_error}")
print(f"(d) Centroid: {x_cen}, {y_cen}")
print(f"(e) Second moments: {second_moment_x}, {second_moment_y}")
print(f"(f) Cross term: {second_moment_xy}")